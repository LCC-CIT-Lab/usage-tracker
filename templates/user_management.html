<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        // When the DOM is fully loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Restore checkbox states
            document.querySelectorAll("input[name='selected_users']").forEach(function(checkbox) {
                const isChecked = localStorage.getItem(checkbox.value) === 'true';
                checkbox.checked = isChecked;
            });
    
            // Save checkbox states on change
            document.querySelectorAll("input[name='selected_users']").forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    localStorage.setItem(checkbox.value, checkbox.checked);
                });
            });
        });
    </script>    
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-header-signin">
                <h2>User Management</h2>
            </div>
            <!-- Add User Form -->
            <div class="add-user-form">
                <h3>Add New User</h3>
                <form action="{{ url_for('admin.add_user') }}" method="post" class="form-layout">
                    {{ form.hidden_tag() }}
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <input type="email" name="email" placeholder="Email" required>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="is_admin"> Admin?</label>
                    </div>
                    <button type="submit" class="form-button">Add User</button>
                </form>
            </div>
            <!-- User Table -->
            <h3>User Table</h3>
            <form action="{{ url_for('admin.apply_bulk_actions') }}" method="post">
                <table>
                    <!-- Table Headers -->
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Admin</th>
                            <th>Can Set Message?</th>
                            <th>IP Mapping Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected_users" value="{{ user.id }}">
                            </td>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ "Yes" if user.is_admin else "No" }}</td>
                            <td>{{ "Yes" if user.can_set_message else "No" }}</td>
                            <td>
                                <!-- List current IP mappings -->
                                {% for ip_location in user.ip_locations %}
                                    <div>{{ ip_location.location_name }}
                                    </div>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Action Buttons -->
                <div class="actions">
                    {{ form.hidden_tag() }}
                    <button type="submit" name="action" value="cycle_ip_mapping">Cycle IP Mapping</button>
                    <button type="submit" name="action" value="remove_users">Remove Selected Users</button>
                </div>
            </form>
            <br><br><br>
            <div class="button-container">
                <div>
                    <!-- Back Button -->
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="button">Back</a>
                </div>
                    <!-- Logout Button -->
                <div>
                    <form action="{{ url_for('auth.logout') }}" method="post">
                        {{ logout_form.hidden_tag() }}
                        <button type="submit" class="buttonsignout">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
