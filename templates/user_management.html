<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        // When the DOM is fully loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Combine related functionalities under a single event listener
            // Restore last selected user
            const lastSelectedUserId = localStorage.getItem('lastSelectedUserId');
            const userSelect = document.getElementById('selected_user');
            if (lastSelectedUserId && userSelect) {
                userSelect.value = lastSelectedUserId;
                updateUserIpSelections(); // Update IP selections for the initially selected user
            }
    
            // Add event listener to user selection dropdown
            if (userSelect) {
                userSelect.addEventListener('change', function() {
                    const selectedUserId = this.value;
                    localStorage.setItem('lastSelectedUserId', selectedUserId); // Store selected user ID
                    updateUserIpSelections(); // Update IP selections
                });
            }
        });
    
        function updateUserIpSelections() {
            // Fetch and update IP mapping selections based on the selected user
            const selectedUserId = document.getElementById('selected_user').value;
            const baseUrl = document.getElementById('base-url').dataset.getUserIpMappingsUrl;
            const url = baseUrl.replace('/0', '/' + selectedUserId);
    
            fetch(url)
                .then(response => response.json())
                .then(assignedIps => {
                    const ipSelectBox = document.getElementById('selected_ip_mappings');
                    Array.from(ipSelectBox.options).forEach(option => {
                        option.selected = assignedIps.includes(parseInt(option.value));
                    });
                })
                .catch(error => console.error('Error fetching user IP mappings:', error));
        }
    
        function assignIpMappings() {
            // Submit IP mapping form with the selected user ID
            const selectedUserId = document.getElementById('selected_user').value;
            document.getElementById('selected_user_id').value = selectedUserId;
            const form = document.getElementById('ip-mapping-form');
            if (form) {
                form.submit();
            } else {
                console.error('IP mapping form not found');
            }
        }
    </script>
</head>
<body>
    <div id="base-url" data-get-user-ip-mappings-url="{{ url_for('admin.get_user_ip_mappings', user_id='0') }}" style="display:none;"></div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="dashboard-header-signin">
                <h2>User Management</h2>
            </div>
            <!-- Add User Form -->
            <div class="add-user-form">
                <h3>Add New User</h3>
                <form action="{{ url_for('admin.add_user') }}" method="post" class="form-layout">
                    {{ form.hidden_tag() }}
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <input type="email" name="email" placeholder="Email" required>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="is_admin"> Admin?</label>
                    </div>
                    <button type="submit" class="form-button">Add User</button>
                </form>
            </div>
            <div>   
                <!-- User Table -->
                <h3>Select a User and Location Assignment</h3>
                <!-- User Management Form -->
                <div>
                    <!-- User Selection Dropdown -->
                        <select name="selected_user" id="selected_user">
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }} - {{ user.email }}</option>
                                {% endfor %}
                        </select>
                    <br>
                    <!-- IP Mapping Form -->
                    <form id="ip-mapping-form" action="{{ url_for('admin.assign_ip_mappings') }}" method="post">
                        {{ form.hidden_tag() }}
                        <!-- IP Mapping Selections -->
                        <select name="selected_ip_mappings" id="selected_ip_mappings" multiple size="5">
                            {% for ip_location in ip_locations %}
                            <option value="{{ ip_location.id }}">{{ ip_location.location_name }}</option>
                            {% endfor %}
                        </select>
                        <!-- Hidden field for selected user ID -->
                        <input type="hidden" name="selected_user_id" id="selected_user_id">
                        <div>
                            <button type="button" class="button" onclick="assignIpMappings()">Assign IP Mappings</button>
                        </div>
                    </form>
                </div>
            </div>
            <br><br>
            <div class="button-container">
                <!-- Back Button -->
                <div>
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="button">Back</a>
                </div>
                <!-- Logout Button -->
                <div>
                    <form action="{{ url_for('auth.logout') }}" method="post">
                        {{ logout_form.hidden_tag() }}
                        <button type="submit" class="buttonsignout">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
